<!DOCTYPE html>
<html>
  <head>
    <title>Risiko</title>
    <link rel='icon' type='image/png' href='/client/img/mappa.jpg' />
  </head>

  <body>
    <div>
      <table>
        <tr>
          <td>
            <canvas id="map" width="1296" height="729" style="background-image: url('/client/img/mappa.jpg'); border:1px solid #000000;">
            </canvas>
          </td>
          <td>
            <div id="chat-text" style="width:350px;height:100px;overflow-y:scroll">
              <div>Hello!</div>
            </div>
            <form id="chat-form" onsubmit="formFunction();return false">
              <input id="chat-input" type="text" style="width:350px"></input>
            </form>
            <br>
            <div>
              Nome giocatori:
            </div>
            <br>
          </td>
          
        </tr>
    </table>
    </div>
  
    <script type="text/javascript" src="/client/js/states.js"></script>
    <script type="text/javascript" src='https://cdn.socket.io/socket.io-1.4.5.js'></script>
    <script>
      // Recupero l'elemento canvas e il constesto del canvas.
      var canvas = document.getElementById("map");
      var context = canvas.getContext("2d");    
      var timer;    

      // Per ogni stato in state creo una circonferenza invisibile di un certo raggio sul nome di ogni stato nella mappa.
     function initCircle() {
        states.forEach(state => {
          context.beginPath();
          context.globalAlpha = 0.0;
          context.arc(state.x, state.y, state.radius, 0, 2 * Math.PI, false);
          context.fillStyle = "rgba(255, 0,0,0.7)";
          context.fill();
        });
      };

      initCircle();

      function isIntersect(point, circle) {
        return Math.sqrt((point.x-circle.x) ** 2 + (point.y - circle.y) ** 2) < circle.radius;
      }

      function flashObject (state) {
        clearInterval(timer);
        context.clearRect(0, 0, canvas.width, canvas.height);
        initCircle();
        var count = 1000;
        timer = setInterval(function() {
          count --;
          if (count % 2 == 1) {
            for (var neighbors in state.neighbor) {
              // Per ogni vicino disegno un cerchio rosso lampeggiante.
              states.forEach(neighborsState => {
                if (neighborsState.name == state.neighbor[neighbors]) {
                  context.beginPath();
                  context.globalAlpha = 1;
                  context.arc(neighborsState.x, neighborsState.y, neighborsState.radius/2, 0, 2 * Math.PI, false);
                  context.fillStyle = "red";
                  context.fill();                                            
                }
              }); 
            }
          }
          else {
            context.clearRect(0, 0, canvas.width, canvas.height);
            initCircle();
          }

          if(count == 0) {
            count = 1000;
          }
        },300);
      }

      canvas.addEventListener('click', (e) => {
        const pos = {
          x: e.clientX,
          y: e.clientY
        };

        // Scorro gli stati.
        states.forEach(state => {
          // Se ho cliccato su uno stato allora continuo.
          if (isIntersect(pos, state)) {
            console.log(state.neighbor);
            // Recupero i vicini dello stato cliccato.
            flashObject(state);
          }
        });
      });


      //var socket = io();

      // Aggiungo quello che ricevo alla chat.
      var chatText = document.getElementById('chat-text');
      socket.on('addToChat', function(data) {
        chatText.innerHTML += '<div>' + data + '</div>';
      });

      // Utilizzo per debug. Ad esempio inserendo in chat /Player.list avr√≤ la lista dei giocatori nella console.
      socket.on('evalAnswer', function(data) {
        console.log(data);
      });
      
      formFunction = function() {
        // Recupero gli elementi di chat.
        var chatInput = document.getElementById('chat-input');
        var chatForm = document.getElementById('chat-form');

        if (chatInput.value[0] == '/') {
          socket.emit('evalServer', chatInput.value.slice(1));
        }
        else {
          socket.emit('sendMsgToServer', chatInput.value);
        }
        // Resetto il valore della casella di chat.
        chatInput.value = '';
        
      };
      
    </script>
    
  </body>
  
  
</html>